# セマンティックセグメンテーション MCP サーバー仕様書

## 概要

このMCPサーバーは、Claude Desktopと接続して画像のセマンティックセグメンテーションを実行するためのサーバーです。入力として画像パスを受け取り、処理結果を静的なディレクトリに保存し、出力画像のURLを返却します。

## システム要件

- Python 3.13.5
- uv (仮想環境管理)
- Claude Desktop (クライアント)

## プロジェクト構造

```
mcp_for_semantic_segmentation/
├── .venv/                          # 仮想環境
├── src/                            # ソースコード
│   ├── __init__.py
│   ├── server.py                   # MCPサーバー本体
│   ├── segmentation.py             # セグメンテーション処理
│   └── utils.py                    # ユーティリティ関数
├── static/                         # 静的ファイル
│   ├── input/                      # 入力画像保存ディレクトリ
│   └── output/                     # 出力画像保存ディレクトリ
├── models/                         # 学習済みモデル
├── requirements.txt                # 依存関係
├── pyproject.toml                 # プロジェクト設定
├── SPECIFICATION.md               # この仕様書
└── README.md                      # プロジェクト説明
```

## 機能仕様

### 1. 入力仕様
- **入力形式**: 画像ファイルパス（文字列）
- **対応形式**: JPEG, PNG, BMP, TIFF
- **最大サイズ**: 10MB
- **入力例**: `"C:/path/to/image.jpg"`

### 2. 処理仕様
- **処理内容**: セマンティックセグメンテーション
- **使用モデル**: 事前学習済みモデル（例：DeepLabV3+, U-Net等）
- **出力形式**: マスク画像（PNG形式）
- **処理時間**: 30秒以内（標準的な画像サイズ）

### 3. 出力仕様
- **出力形式**: JSON
- **出力内容**: 
  ```json
  {
    "status": "success",
    "output_path": "/static/output/result_20241201_143022.png",
    "processing_time": 2.5,
    "input_size": "1920x1080",
    "output_size": "1920x1080"
  }
  ```
- **エラー時出力**:
  ```json
  {
    "status": "error",
    "error_message": "画像ファイルが見つかりません",
    "error_code": "FILE_NOT_FOUND"
  }
  ```

### 4. ファイル管理仕様
- **入力画像**: `static/input/` ディレクトリにコピー
- **出力画像**: `static/output/` ディレクトリに保存
- **ファイル命名規則**: `result_YYYYMMDD_HHMMSS.png`
- **自動クリーンアップ**: 7日以上古いファイルを自動削除

## MCPサーバー仕様

### 1. サーバー設定
- **プロトコル**: MCP (Model Context Protocol)
- **通信方式**: JSON-RPC over stdio
- **ポート**: 標準入出力を使用

### 2. 提供ツール
- **ツール名**: `semantic_segmentation`
- **説明**: 画像のセマンティックセグメンテーションを実行
- **パラメータ**:
  - `image_path` (string, required): 入力画像のパス

### 3. レスポンス形式
```json
{
  "result": {
    "output_url": "file:///static/output/result_20241201_143022.png",
    "message": "セグメンテーションが完了しました"
  }
}
```

## 実装手順

### Phase 1: 環境構築
1. 仮想環境のアクティベート
2. 必要なライブラリのインストール
3. プロジェクト構造の作成

### Phase 2: セグメンテーション処理実装
1. 画像読み込み・前処理
2. セグメンテーションモデルの実装
3. 後処理・マスク生成

### Phase 3: MCPサーバー実装
1. MCPプロトコル対応
2. ツール定義
3. エラーハンドリング

### Phase 4: テスト・統合
1. 単体テスト
2. Claude Desktopとの統合テスト
3. パフォーマンス最適化

## 依存関係

### 必須ライブラリ
- `mcp` - MCPプロトコル実装
- `torch` - PyTorch（ディープラーニング）
- `torchvision` - コンピュータビジョン
- `opencv-python` - 画像処理
- `pillow` - 画像操作
- `numpy` - 数値計算

### 開発用ライブラリ
- `pytest` - テスト
- `black` - コードフォーマット
- `flake8` - リンティング

## セキュリティ考慮事項

1. **入力検証**: ファイルパスの妥当性チェック
2. **ファイルサイズ制限**: 10MB以下
3. **ファイル形式制限**: 画像ファイルのみ
4. **パス検証**: ディレクトリトラバーサル攻撃対策

## パフォーマンス要件

- **処理時間**: 30秒以内
- **メモリ使用量**: 4GB以下
- **同時処理**: 1リクエストずつ（キュー処理）

## エラーハンドリング

### 想定エラー
1. ファイルが見つからない
2. サポートされていない画像形式
3. ファイルサイズ超過
4. モデル読み込みエラー
5. 処理中エラー

### エラーコード
- `FILE_NOT_FOUND`: ファイルが見つからない
- `UNSUPPORTED_FORMAT`: サポートされていない形式
- `FILE_TOO_LARGE`: ファイルサイズ超過
- `MODEL_ERROR`: モデルエラー
- `PROCESSING_ERROR`: 処理エラー

## 今後の拡張予定

1. **複数モデル対応**: 異なるセグメンテーションモデルの選択
2. **バッチ処理**: 複数画像の一括処理
3. **リアルタイム処理**: ストリーミング対応
4. **カスタムモデル**: ユーザー独自モデルの読み込み
5. **結果キャッシュ**: 同じ画像の再処理回避 